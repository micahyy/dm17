name: ZMK Simple Build

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
  workflow_dispatch:

permissions:
  contents: read

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      with:
        submodules: 'recursive'
        
    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'
        
    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y git cmake ninja-build gperf
        pip3 install west
        
    - name: Setup ZMK
      run: |
        west init -m https://github.com/zmkfirmware/zmk.git --mr main zmk
        cd zmk
        west update
        west zephyr-export
        pip3 install -r zephyr/scripts/requirements.txt
        
    - name: Build
      run: |
        cd zmk
        mkdir -p build
        cd build
        
        # 使用简化的构建命令
        cmake -B . -S ../app \
          -DZMK_CONFIG="${{ github.workspace }}/config" \
          -DBOARD=nrf52840dk_nrf52840 \
          -DSHIELD=dm17_dk \
          -GNinja
        
        ninja
        
        echo "Build completed. Files:"
        ls -la zephyr/*.{uf2,hex,bin} 2>/dev/null || true
        
    - name: Upload Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: dm17-firmware
        path: |
          zmk/build/zephyr/zmk.uf2
          zmk/build/zephyr/zmk.hex
          zmk/build/zephyr/zmk.bin
        retention-days: 30
