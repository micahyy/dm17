name: Build DM17 Firmware

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Setup Python and install west
      run: |
        sudo apt-get update
        sudo apt-get install -y python3 python3-pip git
        pip3 install west
        
    - name: Initialize ZMK
      run: |
        # 初始化ZMK
        west init -m https://github.com/zmkfirmware/zmk.git --mr main zmk
        cd zmk
        west update
        
    - name: Install Zephyr dependencies
      run: |
        cd zmk
        pip3 install -r zephyr/scripts/requirements.txt
        
    - name: Build DM17 firmware
      run: |
        cd zmk
        
        # DM17通常使用这些板子之一
        # 尝试常见配置
        for BOARD in "nice_nano_v2" "nice_nano" "nrfmicro_13" "nrfmicro_11" "bluepill"; do
          echo "尝试板子: $BOARD"
          rm -rf build || true
          
          if west build -b $BOARD app -- -DSHIELD=dm17 -DZMK_CONFIG="${{ github.workspace }}/config" 2>&1 | tee build.log; then
            echo "✅ 使用 $BOARD 构建成功"
            break
          else
            echo "❌ $BOARD 失败，尝试下一个..."
          fi
        done
        
        # 检查是否构建成功
        if [ -f "build/zephyr/zmk.uf2" ]; then
          echo "构建成功！"
          ls -la build/zephyr/*.uf2 build/zephyr/*.hex
        else
          echo "构建失败"
          exit 1
        fi
        
    - name: Upload firmware
      uses: actions/upload-artifact@v4
      with:
        name: dm17-firmware
        path: zmk/build/zephyr/zmk.uf2
        retention-days: 30
