name: DM17 Simple Build

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y git cmake ninja-build python3-pip
        pip3 install west
        
    - name: Build with ZMK Docker image
      run: |
        # 使用官方ZMK Docker镜像 - 最简单的方法
        docker pull zmkfirmware/zmk-build-arm:3.0
        
        docker run --rm -v "${{ github.workspace }}:/workspace" \
          -w /workspace \
          zmkfirmware/zmk-build-arm:3.0 \
          /bin/bash -c "
            # 初始化工作区
            west init -l .
            cd zmk
            west update
            west zephyr-export
            
            # 构建DM17
            west build -b nice_nano_v2 app -- \
              -DSHIELD=dm17 \
              -DZMK_CONFIG=/workspace/config
              
            # 复制固件
            cp build/zephyr/zmk.uf2 /workspace/dm17.uf2
          "
          
    - name: Upload firmware
      uses: actions/upload-artifact@v4
      with:
        name: dm17-keyboard
        path: dm17.uf2
