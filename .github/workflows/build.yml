name: Build ZMK Firmware

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:
    inputs:
      board:
        description: 'Target board'
        required: true
        default: 'nrf52840dk_nrf52840'
      shield:
        description: 'Shield name'
        required: true
        default: 'dm17_dk'

env:
  ZEPHYR_BASE: ./zmk/zephyr
  BUILD_DIR: ./zmk/build

jobs:
  build:
    runs-on: ubuntu-22.04
    strategy:
      matrix:
        board: [nrf52840dk_nrf52840]
        shield: [dm17_dk]
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive
          
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
          
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            git cmake ninja-build gperf \
            ccache dfu-util device-tree-compiler \
            wget python3-dev python3-pip python3-setuptools \
            libsdl2-dev libffi-dev libssl-dev
          
      - name: Initialize ZMK
        run: |
          if [ ! -d "./zmk" ]; then
            west init -m https://github.com/zmkfirmware/zmk.git --mr main zmk
          fi
          cd zmk
          west update
          west zephyr-export
          
      - name: Install Zephyr dependencies
        run: |
          cd zmk
          pip3 install -r zephyr/scripts/requirements.txt
          pip3 install -r bootloader/mcuboot/scripts/requirements.txt
          
      - name: Install Zephyr SDK
        run: |
          wget https://github.com/zephyrproject-rtos/sdk-ng/releases/download/v0.16.3/zephyr-sdk-0.16.3_linux-x86_64.tar.xz
          tar xf zephyr-sdk-0.16.3_linux-x86_64.tar.xz
          cd zephyr-sdk-0.16.3
          ./setup.sh -t arm-zephyr-eabi -h -c
          
      - name: Build firmware
        run: |
          cd zmk
          
          # 清理之前的构建
          rm -rf build
          
          # 构建命令
          echo "Building for board: ${{ matrix.board }}, shield: ${{ matrix.shield }}"
          
          west build -b ${{ matrix.board }}\
            --build-dir build/${{ matrix.board }}\
            app \
            -- \
            -DZMK_CONFIG="${{ github.workspace }}/config" \
            -DSHIELD=${{ matrix.shield }} \
            -DCMAKE_EXPORT_COMPILE_COMMANDS=ON
          
          # 检查生成的文件
          echo "Generated files:"
          ls -la build/${{ matrix.board }}/zephyr/*.{uf2,hex,bin} 2>/dev/null || true
          
      - name: Upload firmware artifacts
        uses: actions/upload-artifact@v4
        with:
          name: firmware-${{ matrix.shield }}-${{ matrix.board }}
          path: |
            zmk/build/${{ matrix.board }}/zephyr/zmk.uf2
            zmk/build/${{ matrix.board }}/zephyr/zmk.hex
            zmk/build/${{ matrix.board }}/zephyr/zmk.bin
            zmk/build/${{ matrix.board }}/zephyr/.config
          retention-days: 30
          if-no-files-found: error
          
      - name: Upload build logs on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: build-logs-${{ matrix.shield }}-${{ matrix.board }}
          path: |
            zmk/build/${{ matrix.board }}/**/*.log
            zmk/build/${{ matrix.board }}/**/*.txt
            zmk/build/${{ matrix.board }}/**/CMakeCache.txt
            zmk/build/${{ matrix.board }}/**/CMakeError.log
          retention-days: 7
          if-no-files-found: warn
