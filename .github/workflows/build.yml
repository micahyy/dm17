name: DM17 Final Build

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup
      run: |
        sudo apt update
        sudo apt install -y git cmake python3-pip
        pip3 install west
        
    - name: Prepare ZMK
      run: |
        # 方法：使用 git 直接克隆
        git clone https://github.com/zmkfirmware/zmk.git zmk-src --depth 1
        
        # 设置 west
        cd zmk-src
        west init -l .
        west update
        
        echo "✅ ZMK 准备完成"
        echo "app 目录:"
        ls -la app/ 2>/dev/null || echo "警告: app 目录可能不存在"
        
    - name: Build with explicit path
      run: |
        cd zmk-src
        
        # 明确指定源目录
        if [ -d "app" ]; then
          echo "使用 ./app 作为源目录"
          west build -b nrf52840dk_nrf52840 ./app -- \
            -DSHIELD=dm17 \
            -DZMK_CONFIG="${{ github.workspace }}/config"
        elif [ -d "zmk/app" ]; then
          echo "使用 zmk/app 作为源目录"
          west build -b nrf52840dk_nrf52840 zmk/app -- \
            -DSHIELD=dm17 \
            -DZMK_CONFIG="${{ github.workspace }}/config"
        else
          echo "错误：找不到 app 目录"
          exit 1
        fi
        
    - name: Collect firmware
      run: |
        # 查找并复制固件
        mkdir -p config/firmware
        
        # 尝试多个可能的位置
        possible_locations=(
          "zmk-src/build/zephyr/zmk.uf2"
          "build/zephyr/zmk.uf2"
          "zmk/build/zephyr/zmk.uf2"
        )
        
        for loc in "${possible_locations[@]}"; do
          if [ -f "$loc" ]; then
            cp "$loc" config/firmware/dm17.uf2
            echo "✅ 从 $loc 复制固件"
            break
          fi
        done
        
        if [ ! -f "config/firmware/dm17.uf2" ]; then
          echo "❌ 未找到固件文件"
          echo "搜索所有 .uf2 文件:"
          find . -name "*.uf2" 2>/dev/null || echo "没有找到任何 .uf2 文件"
        else
          echo "✅ 固件已保存到 config/firmware/dm17.uf2"
          ls -l config/firmware/dm17.uf2
        fi
        
    - name: Upload
      uses: actions/upload-artifact@v4
      with:
        name: dm17-firmware
        path: config/firmware/dm17.uf2
        if-no-files-found: warn
